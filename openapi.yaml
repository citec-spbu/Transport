openapi: 3.1.0
info:
  title: Graph Analysis API
  description: >-
    API для загрузки, анализа и визуализации графов маршрутов. Поддерживает
    гостевой вход, вход по email-коду, загрузку наборов данных, кластеризацию и
    вычисление метрик (PageRank, Betweenness).
  version: 1.0.0
paths:
  /v1/auth/request_code:
    post:
      tags:
        - auth
      summary: Request Code
      operationId: request_code_v1_auth_request_code_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestCodeRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestCodeResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /v1/auth/verify_code:
    post:
      tags:
        - auth
      summary: Verify Code
      operationId: verify_code_v1_auth_verify_code_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyCodeRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyCodeResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /v1/auth/guest:
    post:
      tags:
        - auth
      summary: Guest
      operationId: guest_v1_auth_guest_post
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuestTokenResponse'
  /v1/datasets/:
    post:
      tags:
        - datasets
      summary: Upload Dataset
      description: |-
        Загружает новый датасет маршрутов для города.

        Строит граф в Neo4j/GDS на основе выбранного типа
        транспорта и возвращает идентификатор полученного датасета.
      operationId: upload_dataset_v1_datasets__post
      parameters:
        - name: authorization
          in: header
          required: false
          schema:
            anyOf:
              - type: string
              - type: 'null'
            title: Authorization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DatasetUploadRequest'
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatasetUploadResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
    get:
      tags:
        - datasets
      summary: List Datasets
      operationId: list_datasets_v1_datasets__get
      parameters:
        - name: authorization
          in: header
          required: false
          schema:
            anyOf:
              - type: string
              - type: 'null'
            title: Authorization
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatasetListResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /v1/datasets/{dataset_id}:
    delete:
      tags:
        - datasets
      summary: Delete Dataset
      operationId: delete_dataset_v1_datasets__dataset_id__delete
      parameters:
        - name: dataset_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
            title: Dataset Id
        - name: authorization
          in: header
          required: false
          schema:
            anyOf:
              - type: string
              - type: 'null'
            title: Authorization
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema: {}
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /v1/analysis/cluster:
    post:
      tags:
        - analysis
      summary: Cluster Analysis
      description: |-
        Выполняет кластеризацию графа для датасета.

        Принимает параметры метода кластеризации и возвращает узлы
        с метками кластеров и статистику по кластерам.
      operationId: cluster_analysis_v1_analysis_cluster_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClusterRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClusterResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /v1/analysis/metric:
    post:
      tags:
        - analysis
      summary: Metric Analysis
      description: |-
        Рассчитывает выбранную метрику графа для датасета.

        Поддерживает метрики PageRank и Betweenness, возвращает список
        узлов с значениями метрик.
      operationId: metric_analysis_v1_analysis_metric_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MetricAnalysisRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricAnalysisResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
components:
  schemas:
    ClusterNode:
      properties:
        id:
          type: string
          title: Id
        name:
          type: string
          title: Name
        cluster_id:
          type: integer
          title: Cluster Id
          description: Значение кластера
        coordinates:
          items:
            type: number
          type: array
          maxItems: 2
          minItems: 2
          title: Coordinates
          description: '[longitude, latitude]'
          example:
            - 30.33
            - 59.93
      type: object
      required:
        - id
        - name
        - cluster_id
        - coordinates
      title: ClusterNode
    ClusterRequest:
      properties:
        dataset_id:
          type: string
          format: uuid
          title: Dataset Id
          example: b361e37f-a5bc-436d-ac58-dfe573c29aac
        method:
          $ref: '#/components/schemas/ClusteringMethod'
          description: Метод кластеризации
      type: object
      required:
        - dataset_id
        - method
      title: ClusterRequest
    ClusterResponse:
      properties:
        dataset_id:
          type: string
          format: uuid
          title: Dataset Id
        type:
          $ref: '#/components/schemas/ClusteringMethod'
          default: cluster
          example: cluster
        nodes:
          items:
            $ref: '#/components/schemas/ClusterNode'
          type: array
          title: Nodes
        statistics:
          $ref: '#/components/schemas/ClusterStatistics'
      type: object
      required:
        - dataset_id
        - nodes
        - statistics
      title: ClusterResponse
    ClusterStatistics:
      properties:
        modularity:
          type: number
          title: Modularity
          description: Модулярность (0-1, выше лучше)
          example: 0.45
        conductance:
          type: number
          title: Conductance
          description: Проводимость (0-1, ниже лучше)
          example: 0.12
        coverage:
          type: number
          title: Coverage
          description: Покрытие (0-1, выше лучше)
          example: 0.78
      type: object
      required:
        - modularity
        - conductance
        - coverage
      title: ClusterStatistics
    ClusteringMethod:
      type: string
      enum:
        - leiden
        - louvain
      title: ClusteringMethod
    DatasetInfo:
      properties:
        dataset_id:
          type: string
          format: uuid
          title: Dataset Id
        city:
          type: string
          title: City
          example: Saint Petersburg
        transport_type:
          $ref: '#/components/schemas/TransportType'
      type: object
      required:
        - dataset_id
        - city
        - transport_type
      title: DatasetInfo
    DatasetListResponse:
      properties:
        datasets:
          items:
            $ref: '#/components/schemas/DatasetInfo'
          type: array
          title: Datasets
      type: object
      required:
        - datasets
      title: DatasetListResponse
    DatasetUploadRequest:
      properties:
        transport_type:
          $ref: '#/components/schemas/TransportType'
          description: Тип транспорта
          example: bus
        city:
          type: string
          title: City
          description: Город для набора данных
          example: Бирск
      type: object
      required:
        - transport_type
        - city
      title: DatasetUploadRequest
    DatasetUploadResponse:
      properties:
        dataset_id:
          type: string
          format: uuid
          title: Dataset Id
          example: b361e37f-a5bc-436d-ac58-dfe573c29aac
      type: object
      required:
        - dataset_id
      title: DatasetUploadResponse
    GuestTokenResponse:
      properties:
        token:
          type: string
          title: Token
          example: guest-token
      type: object
      required:
        - token
      title: GuestTokenResponse
    HTTPValidationError:
      properties:
        detail:
          items:
            $ref: '#/components/schemas/ValidationError'
          type: array
          title: Detail
      type: object
      title: HTTPValidationError
    MetricAnalysisRequest:
      properties:
        dataset_id:
          type: string
          format: uuid
          title: Dataset Id
          example: b361e37f-a5bc-436d-ac58-dfe573c29aac
        metric_type:
          $ref: '#/components/schemas/MetricType'
      type: object
      required:
        - dataset_id
        - metric_type
      title: MetricAnalysisRequest
    MetricAnalysisResponse:
      properties:
        dataset_id:
          type: string
          format: uuid
          title: Dataset Id
        metric_type:
          $ref: '#/components/schemas/MetricType'
          default: metric
          example: metric
        nodes:
          items:
            $ref: '#/components/schemas/MetricNode'
          type: array
          title: Nodes
      type: object
      required:
        - dataset_id
        - nodes
      title: MetricAnalysisResponse
    MetricNode:
      properties:
        id:
          type: string
          title: Id
        name:
          type: string
          title: Name
        metric:
          type: number
          title: Metric
          description: Значение выбранной метрики
        coordinates:
          items:
            type: number
          type: array
          maxItems: 2
          minItems: 2
          title: Coordinates
          description: '[longitude, latitude]'
          example:
            - 30.33
            - 59.93
      type: object
      required:
        - id
        - name
        - metric
        - coordinates
      title: MetricNode
    MetricType:
      type: string
      enum:
        - pagerank
        - betweenness
      title: MetricType
    RequestCodeRequest:
      properties:
        email:
          type: string
          format: email
          title: Email
          example: user@example.com
      type: object
      required:
        - email
      title: RequestCodeRequest
    RequestCodeResponse:
      properties:
        message:
          type: string
          title: Message
          example: Verification code sent
        token:
          anyOf:
            - type: string
            - type: 'null'
          title: Token
      type: object
      required:
        - message
      title: RequestCodeResponse
    TransportType:
      type: string
      enum:
        - bus
        - tram
        - trolleybus
        - minibus
      title: TransportType
    ValidationError:
      properties:
        loc:
          items:
            anyOf:
              - type: string
              - type: integer
          type: array
          title: Location
        msg:
          type: string
          title: Message
        type:
          type: string
          title: Error Type
      type: object
      required:
        - loc
        - msg
        - type
      title: ValidationError
    VerifyCodeRequest:
      properties:
        email:
          type: string
          title: Email
          example: user@example.com
        code:
          type: string
          title: Code
          example: '123456'
      type: object
      required:
        - email
        - code
      title: VerifyCodeRequest
    VerifyCodeResponse:
      properties:
        token:
          anyOf:
            - type: string
            - type: 'null'
          title: Token
        email:
          type: string
          title: Email
      type: object
      required:
        - email
      title: VerifyCodeResponse
