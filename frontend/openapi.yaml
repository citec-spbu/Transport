openapi: 3.0.3
info:
  title: Graph Analysis API
  description: >
    API для загрузки, анализа и визуализации графов маршрутов.
    Поддерживает гостевой вход, вход по email-коду, загрузку наборов данных,
    кластеризацию и вычисление метрик (PageRank, Betweenness).
  version: "1.0.0"

servers:
  - url: http://localhost:8000
    description: Local development server

paths:

  /auth/request_code:
    post:
      summary: Отправить код подтверждения на email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: user@example.com
      responses:
        "200":
          description: Код отправлен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification code sent

  /auth/verify_code:
    post:
      summary: Проверить код подтверждения и получить токен
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: user@example.com
                code:
                  type: string
                  example: "123456"
      responses:
        "200":
          description: Успешная аутентификация
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  email:
                    type: string

  /auth/guest:
    post:
      summary: Гостевой вход без регистрации
      responses:
        "200":
          description: Гостевой токен выдан
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: guest-token

  /datasets:
    post:
      summary: Загрузить новый набор данных
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                transport_type:
                  type: string
                  description: Тип транспорта
                  example: bus
                city:
                  type: string
                  description: Город для набора данных
                  example: Saint Petersburg
      responses:
        "200":
          description: Набор данных загружен
          content:
            application/json:
              schema:
                type: object
                properties:
                  dataset_id:
                    type: string
                    example: abc123
                  name:
                    type: string
                    example: "Bus routes — Saint Petersburg"
        "400":
          description: Неверные параметры
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Unknown city or transport type"

  /datasets/{dataset_id}:
    delete:
      summary: Удалить набор данных
      parameters:
        - in: path
          name: dataset_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Набор данных удалён

  /analysis/cluster:
    post:
      summary: Запустить кластеризацию графа и получить результат
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dataset_id:
                  type: string
                  example: abc123
                method:
                  type: string
                  enum: [leiden, louvain]
                  description: Метод кластеризации
      responses:
        "200":
          description: Результат кластеризации
          content:
            application/json:
              schema:
                type: object
                properties:
                  dataset_id:
                    type: string
                  type:
                    type: string
                    example: cluster
                  nodes:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        cluster_id:
                          type: number
                          description: Значение кластера (например, 0, 1, 2…)
                        coordinates:
                          type: array
                          description: "[longitude, latitude]"
                          items:
                            type: number
                          example: [30.33, 59.93]

  /analysis/metric:
    post:
      summary: Вычислить метрику графа и получить результат
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dataset_id:
                  type: string
                metric:
                  type: string
                  enum: [pagerank, betweenness]
      responses:
        "200":
          description: Результат вычисления метрики
          content:
            application/json:
              schema:
                type: object
                properties:
                  dataset_id:
                    type: string
                  type:
                    type: string
                    example: metric
                  nodes:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        metric:
                          type: number
                          description: Значение выбранной метрики
                        coordinates:
                          type: array
                          description: "[longitude, latitude]"
                          items:
                            type: number
                          example: [30.33, 59.93]

  